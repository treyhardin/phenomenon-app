---
import { getCollection } from 'astro:content'
import LayoutApp from '../layouts/layoutApp.astro'
import { supabase } from '../lib/supabase'
import Map from '../components/Map.astro'
import MapNavigation from '../components/MapNavigation.astro'

const getCountries = async () => {
	const countries = await getCollection('countries')
	return countries.map((country) => ({
		title: country.data.canonical_name,
		url: `/${country.data.id}`,
		count: country.data.record_count.toLocaleString()
	}))
}

const getReports = async () => {
	const { data: reports, error } = await supabase
		.from('clean_data_mv')
		.select()
		.not('dateOccurred', 'is', null)
		.order('dateOccurred', {ascending: false})
		.limit(60)
	return reports
}

const reports = await getReports()
const countries = await getCountries()
---
<LayoutApp
	title='UAP Database'
  reports={reports}
  activePath="map"
>
  <MapNavigation 
    slot="sidebar"
    reports={reports}
    locations={countries}
  />
  <Map 
    slot="main"
		zoomLevel={0}
  />
</LayoutApp>
---
import { getCollection } from 'astro:content'
import LayoutApp from '../layouts/layoutApp.astro'
import { supabase } from '../lib/supabase'
import Map from '../components/Map.astro'
import MapNavigation from '../components/MapNavigation.astro'

const getCountries = async () => {
	const countries = await getCollection('countries')
	return countries.map((country) => ({
		title: country.data.canonical_name,
		url: `/${country.data.id}`,
		count: country.data.record_count.toLocaleString()
	}))
}

const getReports = async () => {
	const { data: reports, error } = await supabase
		.from('clean_data_mv')
		.select()
		.not('dateOccurred', 'is', null)
		.order('dateOccurred', {ascending: false})
		.limit(40)
	return reports
}

// const mediaById = await import.meta.glob('/public/media/*/*', { eager: true, as: 'url' })
// console.log(mediaById)

const reports = await getReports()
const countries = await getCountries()

// const grouped = {}

// const mediaById = import.meta.glob('/public/media/*/*', { eager: true, as: 'url' })

// const entries = {}

// for (const path in mediaById) {
//   const [, , , id] = path.split('/') // ['', 'public', 'media', 'MUFON_142298', 'file.jpg']
//   if (!entries[id]) entries[id] = []
//   entries[id].push(mediaById[path])
// }

// const contentCollection = Object.entries(entries).map(([id, urls]) => ({
//   id,
//   data: { urls }
// }))



// console.log(contentCollection)

// console.log(reports)
---
<LayoutApp
	title='UAP Database'
  reports={reports}
  activePath="map"
>
  <MapNavigation 
    slot="sidebar"
    reports={reports}
    locations={countries}
  />
  <Map 
    slot="main"
		zoomLevel={0}
  />
</LayoutApp>
---
import { getCollection, getEntry } from 'astro:content'
import { supabase } from '../../lib/supabase'
import LayoutApp from '../../layouts/layoutApp.astro'
import LocationList from '../../components/LocationList.astro'

export async function getStaticPaths() {
  const countries = await getCollection('countries')
  return countries?.map((country) => {
    return { params: { country: country.data.id }, props: { ...country.data } }
  })
}

const { id, canonical_name, record_count } = Astro.props

const { data: reports, error } = await supabase
  .from('Clean Data')
  .select()
  .eq('canonical_country', canonical_name)
  .not('dateOccurred', 'is', null)
  .order('dateOccurred', {ascending: false})
  .limit(20)

if (error) console.log(error)

const countryStates = await getEntry('statesByCountry', id)

const states = countryStates?.data.states.map((state) => ({
	title: state.canonical_name,
	url: `/${id}/${state.id}`,
	count: state.record_count
}))
---
<LayoutApp
  title={canonical_name}
  reports={reports}
>
<LocationList
  breadcrumbs={[
    {
      label: "All Countries",
      url: "/"
    }
  ]}
  categoryTitle={canonical_name}
  categoryCount={record_count}
  locations={states}
/>
</LayoutApp>
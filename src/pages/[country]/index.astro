---
import { getCollection, getEntry } from 'astro:content'
import { supabase } from '../../lib/supabase'
import LayoutApp from '../../layouts/layoutApp.astro'
import LocationList from '../../components/LocationList.astro'

export async function getStaticPaths() {
  const countries = await getCollection('countries')
  return countries?.map((country) => {
    return { 
      params: { 
        country: country.data.id 
      }, 
      props: { 
        ...country.data 
      } 
    }
  })
}

const { id, canonical_name, record_count } = Astro.props
const { country } = Astro.params

const getStates = async () => {
  
  let { data: states, error } = await supabase
    .from('Lookup State')
    .select('*')
    .eq('country', country)
    .order('record_count', { ascending: false })

  return states?.map((state) => ({
    title: state.canonical_name,
    url: `/${country}/${state.id}`,
    count: state.record_count
  }))
}

const getReports = async () => {
  const { data: reports, error } = await supabase
    .from('Clean Data')
    .select()
    .eq('canonical_country', id)
    .not('dateOccurred', 'is', null)
    .order('dateOccurred', {ascending: false})
  return reports
}

const states = await getStates()
const reports = await getReports()

---
<LayoutApp
  title={canonical_name}
  reports={reports?.slice(0, 100)}
>
<LocationList
  breadcrumbs={[
    {
      label: "All Countries",
      url: "/"
    }
  ]}
  categoryTitle={canonical_name}
  categoryCount={record_count}
  locations={states}
/>
</LayoutApp>
---
import { getCollection, getEntry } from 'astro:content';
import { supabase } from '../../../../lib/supabase';
import ReportCard from '../../../../components/ReportCard.astro';
import MasterLayout from '../../../../layouts/layoutMaster.astro';
import LayoutApp from '../../../../layouts/layoutApp.astro';
import LocationList from '../../../../components/LocationList.astro';

export async function getStaticPaths() {
  const states = await getCollection('citiesByState')
  return states.flatMap((state) => {
    return state.data.cities.map((city) => ({ 
      params: {
        country: city.country,
        state: state.id,
        city: city.id
      },
      props: { ...city }
    }))
  })
}

const { id, canonical_name, record_count } = Astro.props
const { country, state } = Astro.params

const countryData = await getEntry('countries', country)
const stateData = await getEntry('states', state)
let recordData = await getEntry('recordsByCity', id)
---
<LayoutApp
  title={`${canonical_name}, ${stateData?.data.canonical_name}, ${countryData?.data.canonical_name}`}
  reports={recordData?.data.records}
>
  <LocationList
    breadcrumbs={[
      {
        label: countryData?.data.canonical_name,
        url: `/${countryData?.data.id}`
      },
      {
        label: stateData?.data.canonical_name,
        url: `/${countryData?.data.id}/${stateData?.data.id}`
      }
    ]}
    categoryTitle={canonical_name}
    categoryCount={record_count}
  />
  <!-- {reports?.map((report) => (
    <ReportCard 
      id={report.id}
      date={report.dateOccurred}
      summary={report.summary}
      city={report.canonical_city}
      state={report.canonical_state}
      country={report.canonical_country}
      shape={report.shape}
    />
  ))} -->
</LayoutApp>
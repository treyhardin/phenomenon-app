---
import { getEntry } from 'astro:content';
import { getCollection } from 'astro:content';
import LayoutApp from '../../../layouts/layoutApp.astro';
import LocationList from '../../../components/LocationList.astro';
import { supabase } from '../../../lib/supabase';

export async function getStaticPaths() {
  const countries = await getCollection('statesByCountry')
  return countries.flatMap((country) => {
    return country.data.states.map((state) => ({ 
      params: {
        country: state.country,
        state: state.id
      },
      props: { ...state }
    }))
  })
}

const { id, canonical_name, country, record_count } = Astro.props

const citiesByState = await getEntry('citiesByState', id)
const countryData = await getEntry('countries', country)
// const recordData = await getEntry('recordsByState', id)

const cities = citiesByState?.data.cities.map((city) => ({
	title: city.canonical_name,
	url: `/${countryData?.data.id}/${id}/${city.id}`,
	count: city.record_count
}))

const { data: reports, error } = await supabase
  .from('Clean Data')
  .select()
  .eq('canonical_state', id)
  .not('dateOccurred', 'is', null)
  .order('dateOccurred', {ascending: false})
  .limit(20)

---
<LayoutApp
  title={`${canonical_name}, ${countryData?.data.canonical_name}`}
  reports={reports}
>
  <LocationList
    breadcrumbs={[
      {
        label: countryData?.data.canonical_name,
        url: `/${countryData?.data.id}`
      }
    ]}
    categoryTitle={canonical_name}
    categoryCount={record_count}
    locations={cities}
  />
</LayoutApp>
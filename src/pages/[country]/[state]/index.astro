---
import { getEntry } from 'astro:content';
import { getCollection } from 'astro:content';
import LayoutApp from '../../../layouts/layoutApp.astro';
import LocationList from '../../../components/LocationList.astro';

export async function getStaticPaths() {
  const countries = await getCollection('statesByCountry')
  return countries.flatMap((country) => {
    return country.data.states.map((state) => ({ 
      params: {
        country: state.country,
        state: state.id
      },
      props: { ...state }
    }))
  })
}

const { id, canonical_name, country, record_count } = Astro.props

const citiesByState = await getEntry('citiesByState', id)
const countryData = await getEntry('countries', country)
const recordData = await getEntry('recordsByState', id)

const cities = citiesByState?.data.cities.map((city) => ({
	title: city.canonical_name,
	url: `/${countryData?.data.id}/${id}/${city.id}`,
	count: city.record_count
}))

---
<LayoutApp
  title={`${canonical_name}, ${countryData?.data.canonical_name}`}
  reports={recordData?.data.records.slice(0, 30)}
>
  <LocationList
    breadcrumbs={[
      {
        label: countryData?.data.canonical_name,
        url: `/${countryData?.data.id}`
      }
    ]}
    categoryTitle={canonical_name}
    categoryCount={record_count}
    locations={cities}
  />
</LayoutApp>